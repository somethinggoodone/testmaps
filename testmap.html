<!DOCTYPE html>
<html>
  <head>
    <title>D2D Map Drawing + SearchBox</title>
<style>
  #map {
    height: 100vh;
    width: 100%;
  }

  /* Position search box at top-right */
  #pac-input {
    box-sizing: border-box;
    border: 1px solid transparent;
    width: 300px;
    height: 40px;
    padding: 0 12px;
    border-radius: 3px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    font-size: 16px;
    outline: none;
    text-overflow: ellipsis;
    position: absolute;
    top: 10px;
    right: 10px; /* Fixed to top-right */
    z-index: 5;
    background-color: white;
  }
</style>

  </head>
  <body>
    <input id="pac-input" type="text" placeholder="Search Victoria, Australia" />
    <div id="map"></div>

    <script>
      let map;
      let drawingManager;
      let drawnPolylines = [];
      let markers = [];

      function initAutocomplete() {
        // Map centered on Victoria
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -37.0, lng: 144.5 },
          zoom: 8,
          mapTypeId: "roadmap",
        });

        // Setup DrawingManager for polyline drawing
        drawingManager = new google.maps.drawing.DrawingManager({
          drawingMode: google.maps.drawing.OverlayType.POLYLINE,
          drawingControl: true,
          drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: ["polyline"],
          },
          polylineOptions: {
            strokeColor: "#FF0000",
            strokeWeight: 3,
          },
        });
        drawingManager.setMap(map);

        // When user finishes drawing a polyline
        google.maps.event.addListener(drawingManager, "polylinecomplete", (polyline) => {
          const path = polyline.getPath().getArray().map(latLng => ({
            lat: latLng.lat(),
            lng: latLng.lng(),
          }));
          drawnPolylines.push(path);
          console.log("Drawn Path:", path);
          sendToSheet(path);
        });

        // Create the search box and link it to the input element
        const input = document.getElementById("pac-input");
        const searchBox = new google.maps.places.SearchBox(input, {
          bounds: new google.maps.LatLngBounds(
            { lat: -39.15, lng: 140.95 }, // SW Victoria approx
            { lat: -33.95, lng: 150.25 }  // NE Victoria approx
          )
        });

        // Bias the SearchBox results towards current map's viewport
        map.addListener("bounds_changed", () => {
          searchBox.setBounds(map.getBounds());
        });

        // Listen for places changed event
        searchBox.addListener("places_changed", () => {
          const places = searchBox.getPlaces();

          if (places.length == 0) {
            return;
          }

          // Clear out old markers
          markers.forEach(marker => marker.setMap(null));
          markers = [];

          // For each place, create a marker and adjust map bounds
          const bounds = new google.maps.LatLngBounds();
          places.forEach(place => {
            if (!place.geometry || !place.geometry.location) {
              console.log("Returned place contains no geometry");
              return;
            }

            const marker = new google.maps.Marker({
              map,
              title: place.name,
              position: place.geometry.location,
            });
            markers.push(marker);

            if (place.geometry.viewport) {
              bounds.union(place.geometry.viewport);
            } else {
              bounds.extend(place.geometry.location);
            }
          });
          map.fitBounds(bounds);
        });
      }

      // Replace this with your real webhook endpoint or backend
      function sendToSheet(pathData) {
        fetch("https://webhook.site/12c7e118-fa32-4528-8398-0870ae68d4c3", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path: pathData, timestamp: new Date().toISOString() }),
        })
          .then(res => console.log("Saved:", res.status))
          .catch(err => console.error("Error saving:", err));
      }
    </script>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg&libraries=drawing,places&callback=initAutocomplete&v=weekly"
      defer
    ></script>
  </body>
</html>

